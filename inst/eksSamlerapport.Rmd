---
params:
  title: tom tittel
  author: ukjent forfatter
  hospitalName: ukjent sykehus
  tableFormat: html
  reshId: 999999
  registryName: norspis
  userFullName: Tore Tester
  userRole: ukjent rolle
title: Norsk kvalitetsregister for behandling av spiseforstyrrelser (NorSpis)
abstract: Her kan det legges inn et sammendrag av rapporten, om det er ønskelig...
date: '`r format(Sys.time(), "%d. %B, %Y")`'
registryName: '`r params$registryName`'
reglogo: '`r system.file("logoNorspis.png", package = "norspis")`'
regtext: '`r readLines(system.file("registryShortDescription.txt", package = "norspis"))`'
userFullName: '`r params$userFullName`'
output:
  fig_caption: yes
---




```{r knitrOptions, include=FALSE}
options(knitr.table.format = params$tableFormat)
knitr::opts_chunk$set(warnings = FALSE, echo = FALSE)
options(stringsAsFactors = FALSE)
Sys.setlocale("LC_TIME", "nb_NO.UTF-8")
```




```{r SKDEcol, include=FALSE}
colPrimary <- c("#000059", "#084594", "#2171b5", "#4292c6", "#6baed6", "#c6dbef")
colNeutral <- c("#4D4D4D", "#737373", "#A6A6A6", "#DADADA")
colKontrast <- "#FF7260"
```

```{r getData}
df <- norspis::queryForlopsOversikt(registryName = registryName,
                                    reshId = params$reshId)

names(df) <- tolower(names(df))
```


# Datagrunnlag
Denne rapporten er generert via Rapporteket for NorSpis av brukeren
`r params$author` logget på med  `r params$userRole`-rolle ved
`r params$hospitalName`. Rapporten er laget den
`r format(Sys.time(), '%d %B, %Y')` og er enten manuelt nedlastet eller
automatisk tilsent  av abonnementstenesten til Rapporteket.

Alle opptellinger og statistikker er gjort per forløp. Det vil si at eventuelle
pasienter med > 1 forløp teller flere ganger.<br>


# Forløpstype
Tabell \@ref(tab:typeForlopAar) under viser totalt antall forløp de `r showN` siste månedene.
```{r typeForlopAar}
cap <- paste("Totalt antall forløp de siste", showN, "månedene.")
d_ablanor %>%
  dplyr::count(forlopstype) %>%
  janitor::adorn_totals() %>%
  ablanor::legg_til_forlopstype_kortnavn(., total = TRUE) %>%
  dplyr::select(forlopstype_tekst, n) %>%
  dplyr::rename("Forløpstype" = forlopstype_tekst) %>%
  rapbase::mst(.,
               type = params$tableFormat,
               cap = cap,
               digs = 1,
               align = "lcc",
               fs = 9, lsd = FALSE)
```

Figur \@ref(fig:typeForlopFig) viser antall forløp per måned de `r showN` siste månedene.
```{r typeForlopFig, fig.cap = paste("Andel forløp per måned de siste", showN, "månedene"), fig.width = 20, fig.height = 10, fig.pos = "H", fig.align = "center", out.width = "\\textwidth" }
d_forlop_mnd <- d_ablanor %>%
  dplyr::count(maaned, forlopstype, .drop = FALSE) %>%
  ablanor::legg_til_forlopstype_kortnavn() %>%
  dplyr::mutate(n_uten0 = case_when(n == 0 ~ "",
                             n != 0 ~ as.character(n))) %>%
  dplyr::mutate(forlopstype_tekst = factor(x = forlopstype_tekst,
                                           levels = c("AFLI", "VT", "SVT", "EFU")))
ggplot2::ggplot(data = d_forlop_mnd, aes(y = n, x = maaned, fill = forlopstype_tekst)) +
  ggplot2::geom_bar(stat = "identity", position = "stack") +
  ggplot2::labs(fill = "Forløpstype") +
  ggplot2::scale_fill_manual(values= colPrimary[3:6]) +
  ggplot2::geom_text(aes(label = n_uten0), position = position_stack(vjust = .5), size=10) +
  ggplot2::scale_y_continuous(name = "Antall forløp", ) +
  ggplot2::theme(panel.grid.major.x = element_blank()) +
  ggplot2::xlab("Måned") +
  ggplot2::theme(text = element_text(size = 20))
```





```{r pagebreak5, results = "asis", eval = (params$tableFormat == "latex")}
  cat("\n\n\\pagebreak\n")
```
